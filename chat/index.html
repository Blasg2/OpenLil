<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b0b0b">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <title>Lil's Chat</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0a0a0a;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* HEADER */
    #chatHeader {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      z-index: 10;
    }

    #backBtn {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
    }

    /* NICKNAME */
    #nicknameScreen {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #667eea, #764ba2);
      padding: 30px;
    }

    #nicknameScreen.hidden { display: none; }

    .nickname-card {
      background: white;
      padding: 30px;
      border-radius: 20px;
      width: 100%;
      max-width: 380px;
    }

    .nickname-card h2 { margin-bottom: 10px; }
    .nickname-card p { margin-bottom: 20px; }

    #nicknameInput {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      margin-bottom: 15px;
    }

    #enterChatBtn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      color: white;
      font-size: 16px;
      border-radius: 10px;
      cursor: pointer;
    }

    /* CHAT */
    #chatScreen {
      display: none;
      flex-direction: column;
      height: 100vh;
    }

    #chatScreen.active { display: flex; }

    #messagesContainer {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column-reverse;
    }

    .message { margin-bottom: 12px; }

    .message-bubble {
      background: #1f1f1f;
      padding: 10px;
      border-radius: 12px;
      max-width: 80%;
    }

    .message-nickname {
      font-weight: bold;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .message-text {
      color: #eee;
      font-size: 15px;
    }

    .message-image {
      max-width: 250px;
      border-radius: 8px;
      margin-top: 6px;
      cursor: pointer;
    }

    .message-time {
      font-size: 11px;
      color: #888;
      text-align: right;
    }

    /* INPUT */
    #inputArea {
      display: flex;
      gap: 8px;
      padding: 10px;
      background: #1a1a1a;
      border-top: 1px solid #2a2a2a;
    }

    #imageBtn, #sendBtn {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border: none;
      background: #667eea;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }

    #messageInput {
      flex: 1;
      background: #2a2a2a;
      border: none;
      color: white;
      padding: 12px;
      border-radius: 20px;
      font-size: 16px;
      resize: none;
      outline: none;
    }

    /* MODAL */
    #imageSourceModal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #imageSourceModal.active { display: flex; }

    .image-source-card {
      background: #1a1a1a;
      padding: 25px;
      border-radius: 16px;
      width: 90%;
      max-width: 320px;
      text-align: center;
    }

    .image-source-card h3 {
      color: white;
      margin-bottom: 18px;
    }

    .image-source-card button {
      width: 100%;
      padding: 14px;
      margin-bottom: 12px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      background: #667eea;
      color: white;
    }

    .image-source-card button.cancel {
      background: transparent;
      color: #aaa;
    }
  </style>
</head>

<body>

<!-- IMAGE SOURCE MODAL -->
<div id="imageSourceModal">
  <div class="image-source-card">
    <h3>Enviar imagem</h3>
    <button onclick="openCamera()">üì∑ C√¢mera</button>
    <button onclick="openGallery()">üñºÔ∏è Galeria</button>
    <button class="cancel" onclick="closeImageSource()">Cancelar</button>
  </div>
</div>

<!-- HIDDEN INPUTS -->
<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none"
       onchange="handleImageSelect(event)">
<input type="file" id="galleryInput" accept="image/*" style="display:none"
       onchange="handleImageSelect(event)">

<!-- NICKNAME -->
<div id="nicknameScreen">
  <div class="nickname-card">
    <h2>Bem-vindo!</h2>
    <p>Escolha um apelido</p>
    <input id="nicknameInput" placeholder="Seu apelido">
    <button id="enterChatBtn" onclick="enterChat()">Entrar</button>
  </div>
</div>

<!-- CHAT -->
<div id="chatScreen">
  <div id="chatHeader">
    <button id="backBtn" onclick="location.href='/'">‚Üê</button>
    <h1>Lil's Chat</h1>
  </div>

  <div id="messagesContainer"></div>

  <div id="inputArea">
    <button id="imageBtn" onclick="openImageSource()">üì∑</button>
    <textarea id="messageInput" placeholder="Mensagem..."></textarea>
    <button id="sendBtn" onclick="sendMessage()">‚û§</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAzpUnWhMkePhLgwf22aA8YUzrUJUc_RlE",
    authDomain: "lilslife.firebaseapp.com",
    databaseURL: "https://lilslife-default-rtdb.firebaseio.com",
    projectId: "lilslife",
    messagingSenderId: "731094352991",
    appId: "1:731094352991:web:6ac2b5b02253f4915947ea"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const messagesRef = db.ref("messages");

  let nickname = sessionStorage.getItem("chatNickname");
  let color = sessionStorage.getItem("chatColor");

  if (nickname && color) showChat();

  function enterChat() {
    nickname = nicknameInput.value.trim();
    if (!nickname) return;
    color = "#"+Math.floor(Math.random()*16777215).toString(16);
    sessionStorage.setItem("chatNickname", nickname);
    sessionStorage.setItem("chatColor", color);
    showChat();
  }

  function showChat() {
    nicknameScreen.classList.add("hidden");
    chatScreen.classList.add("active");
    messagesRef.limitToLast(100).on("child_added", snap => renderMessage(snap.val()));
  }

  function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;
    messagesRef.push({ nickname, color, message: text, timestamp: Date.now() });
    messageInput.value = "";
  }

  function renderMessage(m) {
    const d = document.createElement("div");
    d.className = "message";
    d.innerHTML = `
      <div class="message-bubble">
        <div class="message-nickname" style="color:${m.color}">${m.nickname}</div>
        <div class="message-text">${m.message || ""}</div>
        ${m.imageUrl ? `<img src="${m.imageUrl}" class="message-image">` : ""}
        <div class="message-time">${new Date(m.timestamp).toLocaleTimeString()}</div>
      </div>`;
    messagesContainer.prepend(d);
  }

  function openImageSource() {
    imageSourceModal.classList.add("active");
  }
  function closeImageSource() {
    imageSourceModal.classList.remove("active");
  }
  function openCamera() {
    closeImageSource();
    cameraInput.click();
  }
  function openGallery() {
    closeImageSource();
    galleryInput.click();
  }

  async function handleImageSelect(e) {
    const file = e.target.files[0];
    if (!file) return;
    const fd = new FormData();
    fd.append("image", file);
    const res = await fetch("https://api.imgbb.com/1/upload?key=18ab4a20c315acaf53a635943d332eba", { method:"POST", body:fd });
    const url = (await res.json()).data.url;
    messagesRef.push({ nickname, color, imageUrl:url, timestamp:Date.now() });
    e.target.value = "";
  }

  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/sw.js");
  }
</script>

</body>
</html>
